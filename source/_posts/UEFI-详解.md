---
title: UEFI 详解
date: 2020-06-22 15:09:05
categories: UEFI
tags:
- UEFI
---

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="UEFI-详解/静默山水.jpg">
    <br>
    <div style="color:orange;
    display: inline-block;
    color: #999;
    padding: 2px;">静默山水</div>
</center>

#### 一、UEFI 是什么？
UEFI - Unified Extensible Firmware Interface
从规范的角度来看，它是一个规范，定义了计算机操作系统和平台固件之间的接口规范.

<!-- more -->

从实体的角度来讲，BIOS 和 UEFI 是两种不同类型的计算机固件（什么是固件？就是固化在计算机主板上某个非易失存储区（EEPROM）中的小系统），计算机启动都是先启动它，然后加载真正的操作系统，计算机启动后进入配置界面，我们能直观看到的是 UEFI 固件的 UI，我们通过 UI 来配置这个固件的可配置项，比如：操作系统启动顺序，启动等待时间等等，在 BIOS 时代，所有的设置都只能存储在主板上，容量很小，无法扩展，而 UEFI 将基础固件烧制在主板存储区中，然后在磁盘上创建 EFI 系统分区来存储更多的内容和数据，通过 UEFI 规范来定义如何使用扩展的方式来定制和扩展功能。

#### 二、EFI 系统分区
我们知道在 UEFI 之前的 BIOS 时代，操作系统的 bootlloader 是存放在主引导记录（MBR）中的，容量受限，所以 UEFI 中引入了一个新的系统分区 ESP (EFI System Partition) ，该分区用来存储操作系统的 bootloader 和 EFI 驱动程序等数据，当计算机启动后，UEFI 固件从该分区中加载所需要的硬件驱动，执行 bootloader 启动指定的操作系统。在 Windows 系统中默认该分区不可见，可以参照 如何查看 EFI 分区内容 查看 EFI 分区中的内容。

#### 三、EFI 可执行文件
UEFI 标准定义了一种可执行文件格式，所有的 UEFI 固件都能够执行以这种格式编写的代码，操作系统 bootloader 都采用这种格式编写，比如 Windows 10 64位操作系统的 bootloader 叫做 bootx64.efi，该文件存放在 EFI 系统分区的 Boot 文件夹下，如果一台机器上安装了多个厂商的操作系统，他们的 bootloader 都位于 EFI 系统分区的 Boot 目录中，UEFI 就是通过执行这个 bootloader 来启动指定的操作系统。

![GkAytI.png](https://s1.ax1x.com/2020/03/28/GkAytI.png)

#### 四、GPT 分区表
GUID 分区表格式与 UEFI规范具有密切联系，而且它并不特别复杂，GPT 是 UEFI 规范提供的良好基础架构之一。GPT 仅仅是分区表的一种标准（磁盘起始位置的信息定义了磁盘所包含的分区）。相比 MBR/MS-DOS 分区表，这种分区表对分区的定义要好得多，并且 UEFI 规范要求 UEFI 兼容固件必须能识别 GPT（也要求固件能识别 MBR，以保证向后兼容）。

#### 五、BIOS 如何启动
在了解 UEFI 启动之前，我们看一下 BIOS 的启动过程，BIOS 启动过程非常简单，你需要在第一块磁盘上有一个 MBR（主引导记录，这是一个标准，它定义了一种格式来描述该磁盘分区，并在特定的地方包含一个 boot loader），BIOS 通过加载 MBR 中的这段 boot loader 代码去启动操作系统，操作系统安装程序负责在系统安装过程中将 boot loader 代码写入到 MBR 中的特定区域。

[![GkEzM8.png](https://s1.ax1x.com/2020/03/28/GkEzM8.png)](https://imgchr.com/i/GkEzM8)

从 BIOS 的启动过程中我们可以看出，BIOS 方案存在以下问题：

- 处理不便，你需要特殊工具来写入 MBR，如果要查看 MBR 中包含的内容，唯一的方法几乎就是把 MBR dump 出来，然后进行检查
- MBR 容量受限，无法容纳现代操作系统的 bootloader
- 无法实现从其他启动目标来启动系统，比如：网络启动
- 固件层以上的其他层（比如在操作系统中）无法配置固件的启动行为，BIOS 没有提供相应机制

#### 六、UEFI 如何启动
UEFI 规范定义了一个 boot manager, 它是一个固件策略引擎，可以灵活配置，通过下图的对比图可以看到 UEFI 的启动过程。整个流程没有什么神奇的地方，主要的优势是灵活性和可配置型以及可定制的安全性。

![GkViIs.png](https://s1.ax1x.com/2020/03/28/GkViIs.png)

#### 七、Secure Boot
安全启动解决的问题就是 rootkit 攻击问题。
UEFI 规范规定了固件可以包含一系列签名，并拒绝运行未签名或签名与固件中包含的签名不一致的 EFI 可执行文件，通俗地讲，安全启动就是使用非对称加密和数字签名技术来确保整个启动链的安全，所有不合法的 UEFI 执行程序和驱动程序都不允许执行，这样就解决了操作系统加载前的启动安全问题。当然这是一个可选项，用户可以在 UEFI 配置界面关闭 Secure Boot。


#### 八、为什么需要BIOS和UEFI？

与大多数人基本的概念不同，在某种意义上来说，X86体系比ARM体系更加开放。X86是很多小伙伴一起玩，以生态圈的概念提供产品，并对自己那部分负责；而ARM体系虽然也依赖生态圈，但最终有个大Boss统合整个生态链，提供最后产品并对该产品负总责。

X86生态圈玩家众多，有OS 厂商（OSV）定期发布操作系统，如Windows，Ubuntu；芯片厂商提供CPU，如Intel, AMD；主板厂商（OEM）提供电脑主板；独立硬件供应商（IHV）生产扩展板卡如显卡等等PCIE扩展卡，再如内存厂家推出一代一代不同的内存条等等。

DIY玩家可以自由选择搭配合适/兼容的产品搭配出自己心仪的机器，休闲上网用户花2000多元就可以搭配出一套可用的电脑，而游戏玩家则可能花费上万元才能满足游戏配置需求。还有些品牌机厂商如Dell和联想等，他们提供整套最终产品给用户。但他们实际上是在所有小伙伴的零件基础上拼凑出个产品，技术不强，话语权弱，并不能统一整个产业链。用户津津乐道的反而是用的什么CPU，安装的什么操作系统，用的那种显卡等等。Windows死机、蓝屏和缓慢等等时候，用户往往会抱怨微软和Intel，而不是品牌厂商。

ARM体系由最后品牌厂商统合整个产品，它负责打通整个产业链，并对其中所有部分负责，话语权极强，同时对技术也相对较强。用户面对的具体品牌的产品，而不是碎片化的各个部分。强势的如Apple，硬件软件一起抓，完全组成闭环的链条。稍差也如华为等安卓手机，要负责安卓系统在自己手机移植部分（BSP），客户出了问题并不会找谷歌，而会去找华为。

在X86生态圈十分强势的微软，自己负责操作系统开发，跳过品牌直接服务最终用户，甚至不经允许直接升级操作系统，闹出不少风波。强势也带来了副作用，它要直接面对数千数万种千奇百怪的硬件产品，如何才能用一个软件安装包服务于这么多种设备呢？必须要一个软件抽象层封装这些硬件差别！

这就引出了BIOS和UEFI的最主要的功能：初始化硬件和提供硬件的软件抽象。

ARM体系也要初始化具体主板相关硬件如GPIO和内存等，这些一般在BSP中完成。与X86体系不同之处在于这些硬件完全定制化，初始化的时候就预先知道有哪些设备，Solder Down了哪个品牌的哪种内存颗粒，到时候就照方抓药，初始化一大堆寄存器而已。X86系统配置情况在开机时候是不知道的，需要探测（Probe）、Training(内存和PCIe)和枚举（PCIe等等即插即用设备），相对较复杂。
BIOS和UEFI提供了整个主板、包括主板上外插的设备的软件抽象。通过探测、Training和枚举，BIOS就有了系统所有硬件的信息。它通过几组详细定义好的接口，把这些信息抽象后传递给操作系统，这些信息包括SMBIOS（专栏稍后介绍）、ACPI表（ACPI与UEFI），内存映射表（E820或者UEFI运行时）等等。通过这层映射，才能做到做到操作系统完全不改而能够适配到所有机型和硬件。
在某种程度上来讲，BIOS和UEFI是将操作系统BSP部分单独封装后下放到主板或者BIOS提供商来完成。这在过去带来了巨大的好处，WinXP、Win7现在还可以运行在更新的电脑硬件上，新的硬件只要自己更改一下就行了，兼容性是ARM体系所不能比拟的。当然割裂的生态圈也带来了用户感受的千差万别，这也受到广泛诟病。各自为政也窒息了创新，带来了同质化。为此，Intel越俎代庖，提出了变形本等等概念；而微软更直接出了Surface，似乎要与过去的小伙伴争食。其实这些都是不得已而为之，今后的发展还需要拭目以待。

arm社区最近为了进入x86的传统优势领域，也开始接受uefi，不过一般只在服务器领域。个别厂商为了支持Windows而在平板等设备支持uefi，某厂商在手机上也要引入uefi。不过这些只是支流，并且他们并不吧自己叫做BIOS，而叫做Bootloader。
